<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<input type="hidden" id="csrfToken" name="_csrf" th:value="${_csrf.token}">

<div th:fragment="boardContent">
    <div class="pd-tab-content" id="board-content" style="display: none;">

        <!-- Board Controls -->
        <div class="pd-board-controls">
            <div class="pd-search">
                <span class="pd-search-icon"><i class="fas fa-search"></i></span>
                <input type="text" placeholder="Search board"/>
            </div>

            <div class="pd-people" id="pdPeopleBtn">
                <i class="fas fa-users"></i>
                <span class="pd-people-dots">‚ãØ</span>
            </div>
            
				<a th:if="${board.currentUserIsPm}" class="pd-add-member-btn"
					th:href="@{|/projects/${board.projectId}/members/add|}"> <i
					class="fas fa-user-plus"></i> Add member
				</a>

				<button class="pd-filter is-active">
                <span class="pd-filter-icon"><i class="fas fa-chevron-down"></i></span>
                Filter
            </button>
				<button type="button" id="pdAiSuggestBtn" class="pd-ai-suggest-btn"
					th:if="${board.currentUserIsPm}">
					<i class="fas fa-magic"></i> AI suggest tasks
				</button>
				
				
				<button type="button" id="pdAiAssignBtn"
			        class="pd-ai-suggest-btn pd-ai-assign-project-btn"
			        th:if="${board.currentUserIsPm}">
			  <i class="fas fa-user-astronaut"></i> AI suggest assignees
			</button>


				<div class="pd-group">
                <select>
                    <option>Group by</option>
                </select>
            </div>

            <div class="pd-view-icons">
                <button class="pd-view-btn is-active"><i class="fas fa-th"></i></button>
                <button class="pd-view-btn"><i class="fas fa-list"></i></button>
                <button class="pd-view-btn"><i class="fas fa-chart-bar"></i></button>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="pd-kanban-board" th:attr="data-project-id=${board.projectId}, data-is-pm=${board.currentUserIsPm}">

            <!-- TO DO Column -->
            <div class="pd-column">
                <div class="pd-column-header">
                    <h3>TO DO</h3>
                    <span class="pd-count" th:text="${#lists.size(board.todo)}">0</span>
                </div>

                <div class="pd-cards">
                    <!-- Tasks -->
                    <div class="pd-card"
                         th:each="task : ${board.todo}"
                         th:attr="data-task-id=${task.taskId},
                                  data-task-summary=${task.summary},
                                  data-task-status=${task.status},
                                  data-task-type=${task.type},
                                  data-task-priority=${task.priority},
                                  data-task-due-date=${task.dueDate},
                                  data-task-assignees=${#strings.arrayJoin(task.assignees, ', ')},
                                  data-task-assignee-ids=${#strings.arrayJoin(task.assigneeIds, ',')},
                                  data-can-change-status=${task.canChangeStatus}">
                        <div class="pd-card-header">
                            <span class="pd-card-dot"></span>
                        </div>
                        <h4 th:text="${task.summary}">Task title</h4>
                        <p class="pd-card-type" th:text="${task.type}">Task</p>
                        <div class="pd-card-footer">
                            <span class="pd-card-id" th:text="${'TASK-' + task.taskId}">TASK-1</span>
                            <span class="pd-card-date" th:text="${task.dueDate}">2025-11-30</span>
                        </div>
				     <!-- ‚úÖ n√∫t AI suggest assignee -->
				    <button type="button"
				            class="pd-ai-assign-btn"
				            th:if="${board.currentUserIsPm}"
				            th:attr="data-task-id=${task.taskId}">
				        <i class="fas fa-user-check"></i>
				        AI Suggest Assignee
				    </button>
                    </div>

                    <!-- Create card -->
                    <div class="pd-card pd-card-create"
                         th:if="${board.currentUserIsPm}">
                        <button type="button" class="pd-create-task-open"
                                data-status="TODO">+ Create</button>
                    </div>
                </div>
            </div>

            <!-- IN PROGRESS Column -->
            <div class="pd-column">
                <div class="pd-column-header">
                    <h3>IN PROGRESS</h3>
                    <span class="pd-count" th:text="${#lists.size(board.inProgress)}">0</span>
                </div>

                <div class="pd-cards">
                    <div class="pd-card"
                         th:each="task : ${board.inProgress}"
                         th:attr="data-task-id=${task.taskId},
                                  data-task-summary=${task.summary},
                                  data-task-status=${task.status},
                                  data-task-type=${task.type},
                                  data-task-priority=${task.priority},
                                  data-task-due-date=${task.dueDate},
                                  data-task-assignees=${#strings.arrayJoin(task.assignees, ', ')},
                                  data-task-assignee-ids=${#strings.arrayJoin(task.assigneeIds, ',')},
                                  data-can-change-status=${task.canChangeStatus}">
                        <div class="pd-card-header">
                            <span class="pd-card-dot"></span>
                        </div>
                        <h4 th:text="${task.summary}">Task title</h4>
                        <p class="pd-card-type" th:text="${task.type}">Task</p>
                        <div class="pd-card-footer">
                            <span class="pd-card-id" th:text="${'TASK-' + task.taskId}">TASK-2</span>
                            <span class="pd-card-date" th:text="${task.dueDate}">2025-12-05</span>
                        </div>
                    </div>

                    <div class="pd-card pd-card-create"
                         th:if="${board.currentUserIsPm}">
                        <button type="button" class="pd-create-task-open"
                                data-status="IN_PROGRESS">+ Create</button>
                    </div>
                </div>
            </div>

            <!-- REVIEW Column -->
            <div class="pd-column">
                <div class="pd-column-header">
                    <h3>REVIEW</h3>
                    <span class="pd-count" th:text="${#lists.size(board.review)}">0</span>
                </div>

                <div class="pd-cards">
                    <div class="pd-card"
                         th:each="task : ${board.review}"
                         th:attr="data-task-id=${task.taskId},
                                  data-task-summary=${task.summary},
                                  data-task-status=${task.status},
                                  data-task-type=${task.type},
                                  data-task-priority=${task.priority},
                                  data-task-due-date=${task.dueDate},
                                  data-task-assignees=${#strings.arrayJoin(task.assignees, ', ')},
                                  data-task-assignee-ids=${#strings.arrayJoin(task.assigneeIds, ',')},
                                  data-can-change-status=${task.canChangeStatus}">
                        <div class="pd-card-header">
                            <span class="pd-card-dot"></span>
                        </div>
                        <h4 th:text="${task.summary}">Task title</h4>
                        <p class="pd-card-type" th:text="${task.type}">Task</p>
                        <div class="pd-card-footer">
                            <span class="pd-card-id" th:text="${'TASK-' + task.taskId}">TASK-3</span>
                            <span class="pd-card-date" th:text="${task.dueDate}">2025-12-10</span>
                        </div>
                    </div>

                    <div class="pd-card pd-card-create"
                         th:if="${board.currentUserIsPm}">
                        <button type="button" class="pd-create-task-open"
                                data-status="REVIEW">+ Create</button>
                    </div>
                </div>
            </div>

            <!-- DONE Column -->
            <div class="pd-column">
                <div class="pd-column-header">
                    <h3>DONE</h3>
                    <span class="pd-count" th:text="${#lists.size(board.done)}">0</span>
                </div>

                <div class="pd-cards">
                    <div class="pd-card"
                         th:each="task : ${board.done}"
                         th:attr="data-task-id=${task.taskId},
                                  data-task-summary=${task.summary},
                                  data-task-status=${task.status},
                                  data-task-type=${task.type},
                                  data-task-priority=${task.priority},
                                  data-task-due-date=${task.dueDate},
                                  data-task-assignees=${#strings.arrayJoin(task.assignees, ', ')},
                                  data-task-assignee-ids=${#strings.arrayJoin(task.assigneeIds, ',')},
                                  data-can-change-status=${task.canChangeStatus}">
                        <div class="pd-card-header">
                            <span class="pd-card-dot"></span>
                        </div>
                        <h4 th:text="${task.summary}">Task title</h4>
                        <p class="pd-card-type" th:text="${task.type}">Task</p>
                        <div class="pd-card-footer">
                            <span class="pd-card-id" th:text="${'TASK-' + task.taskId}">TASK-4</span>
                            <span class="pd-card-date" th:text="${task.dueDate}">2025-11-10</span>
                        </div>
                    </div>

                    <div class="pd-card pd-card-create"
                         th:if="${board.currentUserIsPm}">
                        <button type="button" class="pd-create-task-open"
                                data-status="DONE">+ Create</button>
                    </div>
                </div>
            </div>

        </div>
        <!-- /pd-kanban-board -->

        <!-- Task Detail Modal -->
        <div id="pdTaskDetailModal" class="pd-task-modal-overlay" style="display: none;">
            <div class="pd-task-modal">

                <div class="pd-task-modal-header">
                    <div>
                        <span class="pd-task-modal-title">Task detail</span>
                        <span id="taskDetailStatusBadge" class="pd-task-status-pill">To Do</span>
                    </div>
                    <button type="button" id="pdTaskDetailClose" class="pd-task-modal-close">‚úï</button>
                </div>

                <!-- Form ch·ªâ d√πng ƒë·ªÉ update STATUS (t·∫°m th·ªùi) -->
                <form id="pdTaskStatusForm" method="post" enctype="multipart/form-data">
                    <!-- action s·∫Ω set b·∫±ng JS: /projects/{projectId}/tasks/{taskId}/status -->

                    <div class="pd-task-modal-body">

                        <div class="pd-form-row">
                            <label class="pd-form-label">Summary</label>
                            <input id="taskDetailSummary" name="title" class="pd-input"/>
                        </div>

                        <div class="pd-form-row">
                            <label class="pd-form-label">Type</label>
                            <input id="taskDetailType" name="type" class="pd-input" />
                        </div>
                        
							<div class="pd-form-row">
								<label class="pd-form-label">Description</label>
								<textarea id="taskDetailDescription" name="description" class="pd-input"></textarea>
							</div>


							<div class="pd-form-row pd-form-row-inline">
                            <div class="pd-priority-col">
                                <label class="pd-form-label">Priority</label>
                                <input id="taskDetailPriority" name="priority" class="pd-input" />
                            </div>
                            <div class="pd-date-col">
                                <label class="pd-form-label">Due date</label>
                                <input id="taskDetailDueDate" name="dueDate" type = "date" class="pd-input"/>
                            </div>
                        </div>

							<div class="pd-form-row">
								<label class="pd-form-label">Assignees</label>
								 <select
									id="taskDetailAssigneesSelect" name="assigneeIds"
									class="pd-select pd-assignees-select" multiple>
									<option th:each="m : ${board.members}" th:value="${m.userId}"
										th:text="${m.fullName}"></option>
								</select>
							</div>

							<div class="pd-form-row">
                            <label class="pd-form-label">Status</label>
                            <select name="status" id="taskDetailStatusSelect" class="pd-select">
                                <option value="TODO">To Do</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="REVIEW">Review</option>
                                <option value="DONE">Done</option>
                            </select>
                        </div>
                        
	                                                <div class="pd-form-row">
	                                                    <label class="pd-form-label">Attach file</label>
	                                                    <input type="file" id="taskDetailFiles" name="resourceFile" class="pd-input">
	                                                    <input type="text" name="resourceNote" class="pd-input" placeholder="M√¥ t·∫£ file (optional)">
	                                                </div>

                    </div>

                    <div class="pd-task-modal-footer">
                        <button type="submit" id="taskDetailUpdateBtn" class="pd-btn-primary">
                            Update
                        </button>
                        <button id="taskDetailDeleteBtn" class="pd-task-delete-btn">Delete</button>
                    </div>
                </form>

            </div>
        </div>
        
        <!-- AI Suggest Tasks Modal -->
<!-- AI Suggest Tasks Modal -->
<div id="pdAiSuggestModal" class="pd-task-modal-overlay" style="display: none;">
  <div class="pd-task-modal">
    <div class="pd-task-modal-header">
      <div>
        <span class="pd-task-modal-title">AI suggested tasks</span>
        <span class="pd-task-status-pill">Support only</span>
      </div>
      <button type="button" id="pdAiSuggestClose" class="pd-task-modal-close">‚úï</button>
    </div>

    <div class="pd-task-modal-body">
      <div class="pd-form-row">
        <label class="pd-form-label">Note for AI (optional)</label>
        <textarea id="pdAiNoteInput" class="pd-input"
          placeholder="V√≠ d·ª•: chia nh·ªè backend login, permission, dashboard..."></textarea>
      </div>

      <div class="pd-form-row">
        <button type="button" id="pdAiGenerateBtn" class="pd-btn-primary">
          Generate suggestions
        </button>
        <span id="pdAiLoadingText" style="margin-left: 8px; font-size: 13px; display: none;">
          ƒêang g·ªçi AI...
        </span>
      </div>

      <div class="pd-form-row">
        <label class="pd-form-label">AI suggested tasks</label>
        <div id="pdAiSuggestList" class="pd-ai-suggest-list"></div>
      </div>
    </div>

    <div class="pd-task-modal-footer">
      <button type="button" id="pdAiSaveBtn" class="pd-btn-primary">
        Save selected as tasks
      </button>
    </div>
  </div>
</div>





<!-- ================== AI ASSIGNEE (PROJECT LEVEL) MODAL ================== -->
<div id="pdAiAssignProjectModal" class="pd-task-modal-overlay" style="display:none;">
  <div class="pd-task-modal">
    <div class="pd-task-modal-header">
      <div>
        <span class="pd-task-modal-title">AI suggested assignees</span>
        <span class="pd-task-status-pill">Project level</span>
      </div>
      <button type="button" id="pdAiAssignProjectClose" class="pd-task-modal-close">‚úï</button>
    </div>

    <div class="pd-task-modal-body">
      <!-- optional note gi·ªëng suggest task -->
      <div class="pd-form-row">
        <label class="pd-form-label">Note for AI (optional)</label>
        <textarea id="pdAiAssignProjectNote" class="pd-input"
          placeholder="V√≠ d·ª•: ∆∞u ti√™n FE cho UI, BE cho API..."></textarea>
      </div>
      <div class="pd-form-row">
  <button type="button" id="pdAiAssignProjectGenBtn" class="pd-btn-primary">
    Generate suggestions
  </button>
  <span id="pdAiAssignProjectLoading"
        style="display:none;font-size:13px;margin-left:8px;">
    ƒêang g·ªçi AI...
  </span>
</div>
      

      <div class="pd-form-row">
        <div id="pdAiAssignProjectLoading" style="display:none;font-size:13px;">
          ƒêang g·ªçi AI...
        </div>
      </div>

      <div class="pd-form-row">
        <label class="pd-form-label">AI suggested assignees</label>
        <div id="pdAiAssignProjectList" class="pd-ai-suggest-list">
          <!-- JS ƒë·ªï card v√†o ƒë√¢y -->
        </div>
      </div>
    </div>

    <div class="pd-task-modal-footer">
      <button type="button" id="pdAiAssignProjectApplyBtn" class="pd-btn-primary">
        Apply suggestions
      </button>
      <span style="font-size:12px;margin-left:8px;">
        (PM c√≥ th·ªÉ xem l√Ω do r·ªìi apply 1 l·∫ßn cho c·∫£ project)
      </span>
    </div>
  </div>
</div>


<!-- ================== AI ASSIGNEE (PER-TASK) MODAL ================== -->
<div id="pdAiAssignModal" class="pd-task-modal-overlay" style="display:none;">
  <div class="pd-task-modal">
    <div class="pd-task-modal-header">
      <div>
        <span class="pd-task-modal-title">AI suggested assignees</span>
        <span id="pdAiAssignTaskTitle" class="pd-task-status-pill">TASK</span>
      </div>
      <button type="button" id="pdAiAssignClose" class="pd-task-modal-close">‚úï</button>
    </div>

    <div class="pd-task-modal-body">
      <div id="pdAiAssignLoading" style="display:none;font-size:13px;">
        ƒêang g·ªçi AI...
      </div>

      <div id="pdAiAssignList" class="pd-ai-suggest-list">
       
      </div>
    </div>

    <div class="pd-task-modal-footer">
      <button type="button" id="pdAiAssignApplyBtn" class="pd-btn-primary">
        Apply suggestions
      </button>
      <span style="font-size:12px;margin-left:8px;">
        (C√≥ th·ªÉ b·ªè tick tr∆∞·ªõc khi apply)
      </span>
    </div>
  </div>
</div>




        

    </div> <!-- /.pd-tab-content -->
    
<script>
document.addEventListener('DOMContentLoaded', function () {
    const boardEl = document.querySelector('.pd-kanban-board');
    if (!boardEl) return;

    const projectId = boardEl.getAttribute('data-project-id');
    const isPm = boardEl.getAttribute('data-is-pm') === 'true';

    // ========== TASK DETAIL MODAL ==========
    const modalOverlay = document.getElementById('pdTaskDetailModal');
    const closeBtn = document.getElementById('pdTaskDetailClose');
    const form = document.getElementById('pdTaskStatusForm');

    const titleInput = document.getElementById('taskDetailSummary');
    const typeInput = document.getElementById('taskDetailType');
    const priorityInput = document.getElementById('taskDetailPriority');
    const dueDateInput = document.getElementById('taskDetailDueDate');
    const assigneesSelect = document.getElementById('taskDetailAssigneesSelect');
    const statusSelect = document.getElementById('taskDetailStatusSelect');
    const statusBadge = document.getElementById('taskDetailStatusBadge');
    const updateBtn = document.getElementById('taskDetailUpdateBtn');
    const fileInput = document.getElementById('taskDetailFiles');

    function openModalForTask(cardEl) {
        const taskId = cardEl.getAttribute('data-task-id');
        const summary = cardEl.getAttribute('data-task-summary') || '';
        const status = cardEl.getAttribute('data-task-status') || 'To Do';
        const type = cardEl.getAttribute('data-task-type') || '';
        const priority = cardEl.getAttribute('data-task-priority') || '';
        const dueDate = cardEl.getAttribute('data-task-due-date') || '';
        const assigneeIdsStr = cardEl.getAttribute('data-task-assignee-ids') || '';
        const canChange = cardEl.getAttribute('data-can-change-status') === 'true';

        // Fill info
        titleInput.value = summary;
        typeInput.value = type;
        priorityInput.value = priority;
        dueDateInput.value = dueDate;
        statusBadge.textContent = status;

        if (assigneesSelect) {
            for (let opt of assigneesSelect.options) {
                opt.selected = false;
            }
            if (assigneeIdsStr) {
                const selectedIds = assigneeIdsStr.split(',');
                for (let opt of assigneesSelect.options) {
                    if (selectedIds.includes(opt.value)) {
                        opt.selected = true;
                    }
                }
            }
        }

        // Map status text -> code for select
        let statusCode = 'TODO';
        if (status === 'In Progress') statusCode = 'IN_PROGRESS';
        else if (status === 'Review') statusCode = 'REVIEW';
        else if (status === 'Done') statusCode = 'DONE';

        statusSelect.value = statusCode;

        // Set form action - ALWAYS use /update endpoint as it handles file uploads
        form.action = '/projects/' + projectId + '/tasks/' + taskId + '/update';


        // Quy·ªÅn ƒë·ªïi status
        const descInput = document.getElementById("taskDetailDescription");

        // Start with the most restrictive state
        statusSelect.disabled = true;
        updateBtn.disabled = true;
        assigneesSelect.disabled = true;
        if (fileInput) fileInput.disabled = true;

        titleInput.readOnly = true;
        typeInput.readOnly = true;
        priorityInput.readOnly = true;
        dueDateInput.readOnly = true;
        if (descInput) descInput.readOnly = true;

        // Grant permissions based on roles
        // If user is PM or Assignee
        if (canChange) {
            statusSelect.disabled = false;
            updateBtn.disabled = false;
            if (fileInput) fileInput.disabled = false; // Both PM and Assignee can upload
        }

        // If user is PM, grant additional permissions
        if (isPm) {
            assigneesSelect.disabled = false;
            titleInput.readOnly = false;
            typeInput.readOnly = false;
            priorityInput.readOnly = false;
            dueDateInput.readOnly = false;
            if (descInput) descInput.readOnly = false;
        }


        modalOverlay.style.display = 'flex';
    }

    function closeModal() {
        modalOverlay.style.display = 'none';
    }

    // Click v√†o card (tr·ª´ card create)
    boardEl.addEventListener('click', function (e) {
        const cardEl = e.target.closest('.pd-card');
        if (!cardEl) return;

        if (cardEl.classList.contains('pd-card-create')) {
            // card create: ƒë·ªÉ script create task x·ª≠ l√Ω ri√™ng
            return;
        }

        openModalForTask(cardEl);
    });

    if (closeBtn) {
        closeBtn.addEventListener('click', function () {
            closeModal();
        });
    }

    // Click ra n·ªÅn t·ªëi c≈©ng ƒë√≥ng modal
    modalOverlay.addEventListener('click', function (e) {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });

    // ========== CREATE TASK MODAL (ƒë·ªÉ AI autofill) ==========
    const createModal = document.getElementById('pdTaskModalOverlay');
    const createForm = document.getElementById('pdTaskCreateForm');
    let createTitleInput, createDescInput, createTypeSelect, createPrioritySelect,
        createDueDateInput, createStatusInput, createStatusBadge, createAssigneesSelect;

    if (createForm && createModal) {
        createStatusInput = document.getElementById('pdTaskStatusInput');
        createStatusBadge = document.getElementById('pdTaskModalStatusBadge');
        createTitleInput = createForm.querySelector('input[name="title"]');
        createDescInput = createForm.querySelector('textarea[name="description"]');
        createTypeSelect = createForm.querySelector('select[name="type"]');
        createPrioritySelect = createForm.querySelector('select[name="priority"]');
        createDueDateInput = createForm.querySelector('input[name="dueDate"]');
        createAssigneesSelect = createForm.querySelector('select[name="assigneeIds"]');
    }

    function mapAiTypeToFormType(aiType) {
        if (!aiType) return 'Task';
        const t = aiType.toLowerCase();
        if (t.includes('bug')) return 'Bug';
        if (t.includes('story') || t.includes('feature')) return 'Story';
        return 'Task';
    }

    function mapAiPriorityToFormPriority(aiPriority) {
        if (!aiPriority) return 'MEDIUM';
        const p = aiPriority.toLowerCase();
        if (p.startsWith('h')) return 'HIGH';
        if (p.startsWith('l')) return 'LOW';
        return 'MEDIUM';
    }

    function openCreateModalWithSuggestion(suggestedTask) {
        if (!createModal || !createForm) {
            console.warn('Create task modal not found in DOM.');
            return;
        }

        // Default status = TODO
        if (createStatusInput) {
            createStatusInput.value = 'TODO';
        }
        if (createStatusBadge) {
            createStatusBadge.textContent = 'TODO';
        }

        // ƒê·ªï data t·ª´ AI
        if (createTitleInput) {
            createTitleInput.value = suggestedTask.title || '';
        }
        if (createDescInput) {
            createDescInput.value = suggestedTask.description || '';
        }
        if (createTypeSelect) {
            createTypeSelect.value = mapAiTypeToFormType(suggestedTask.taskType);
        }
        if (createPrioritySelect) {
            createPrioritySelect.value = mapAiPriorityToFormPriority(suggestedTask.priority);
        }

        if (createDueDateInput) {
            createDueDateInput.value = '';
        }
        if (createDueDateInput) {
            const duration = suggestedTask.durationDays ?? null;
            if (duration && duration > 0) {
                const today = new Date();
                today.setDate(today.getDate() + duration);

                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');

                createDueDateInput.value = `${yyyy}-${mm}-${dd}`;
            } else {
                createDueDateInput.value = '';
            }
        }
        if (createAssigneesSelect) {
            for (let opt of createAssigneesSelect.options) {
                opt.selected = false;
            }
        }

        createModal.style.display = 'flex';
    }

    // ========== AI SUGGEST TASKS ==========
    const aiBtn = document.getElementById('pdAiSuggestBtn');
    const aiModal = document.getElementById('pdAiSuggestModal');
    const aiCloseBtn = document.getElementById('pdAiSuggestClose');
    const aiNoteInput = document.getElementById('pdAiNoteInput');
    const aiGenerateBtn = document.getElementById('pdAiGenerateBtn');
    const aiLoadingText = document.getElementById('pdAiLoadingText');
    const aiList = document.getElementById('pdAiSuggestList');
    const aiSaveBtn = document.getElementById('pdAiSaveBtn');

    function openAiModal() {
        if (!aiModal) return;
        aiNoteInput.value = '';
        aiList.innerHTML = '';
        aiModal.style.display = 'flex';
    }

    function closeAiModal() {
        if (!aiModal) return;
        aiModal.style.display = 'none';
    }

    if (aiBtn) {
        aiBtn.addEventListener('click', function () {
            openAiModal();
        });
    }

    if (aiCloseBtn) {
        aiCloseBtn.addEventListener('click', function () {
            closeAiModal();
        });
    }

    if (aiModal) {
        aiModal.addEventListener('click', function (e) {
            if (e.target === aiModal) {
                closeAiModal();
            }
        });
    }

    // G·ªçi API AI ƒë·ªÉ l·∫•y g·ª£i √Ω task
    if (aiGenerateBtn) {
        aiGenerateBtn.addEventListener('click', function () {
            aiLoadingText.style.display = 'inline';
            aiList.innerHTML = '';

            const note = aiNoteInput.value || '';

            fetch('/api/ai/projects/' + projectId + '/suggest-new-tasks?note=' + encodeURIComponent(note), {
                method: 'POST'
            })
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error('AI API error: ' + resp.status);
                    }
                    return resp.json();
                })
                .then(result => {
				    const data = result.newTasks || [];
				
				    if (!Array.isArray(data) || data.length === 0) {
				        aiList.innerHTML = '<p style="font-size: 13px;">AI ch∆∞a g·ª£i √Ω ƒë∆∞·ª£c task n√†o.</p>';
				        return;
				    }
				
				    const frag = document.createDocumentFragment();
				
				    data.forEach((task, index) => {
				        const wrapper = document.createElement('div');
				        wrapper.className = 'pd-ai-task-card';
				
				        const title = task.title || 'Untitled task';
				        const description = task.description || '';
				        const priorityUpper = (task.priority || 'MEDIUM').toUpperCase();
				        const estO = task.estimateOptimistic ?? '';
				        const estL = task.estimateLikely ?? '';
				        const estP = task.estimatePessimistic ?? '';
				        const durationDays = task.durationDays ?? '';
				
				        wrapper.innerHTML = `
				            <div class="pd-ai-task-header">
				                <input type="checkbox" class="pd-ai-task-checkbox" data-index="${index}">
				                <span class="pd-ai-task-title">${title}</span>
				                <span class="pd-ai-task-priority ${priorityUpper}">${priorityUpper}</span>
				            </div>
				
				            <div class="pd-ai-task-desc">${description}</div>
				
				            <div class="pd-ai-task-meta">
				                Estimation (O/L/P):
				                <strong>${estO} / ${estL} / ${estP} h</strong>
				            </div>
				
				            <div class="pd-ai-task-meta">
				                Duration:
				                <strong>${durationDays || '?'} days</strong>
				            </div>
				
				            <div class="pd-ai-task-actions">
				                <button type="button"
				                        class="pd-ai-use-btn"
				                        data-index="${index}">
				                    <span>Use in create form</span>
				                    <span class="pd-ai-use-btn-arrow">‚Üó</span>
				                </button>
				            </div>
				        `;
				
				        frag.appendChild(wrapper);
				    });
				
				    aiList.appendChild(frag);
				    aiList.__aiData = data;  // v·∫´n l∆∞u list tasks th√¥i
				})

                .catch(err => {
                    console.error(err);
                    aiList.innerHTML = '<p style="color: #f66; font-size: 13px;">C√≥ l·ªói khi g·ªçi AI. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
                })
                .finally(() => {
                    aiLoadingText.style.display = 'none';
                });
        });
    }
    
    const aiAssignBtn = document.getElementById("pdAiAssignBtn");
	
	 // modal elems
	 const assignProjectModal = document.getElementById("pdAiAssignProjectModal");
	 const assignProjectClose = document.getElementById("pdAiAssignProjectClose");
	 const assignProjectNote = document.getElementById("pdAiAssignProjectNote");
	 const assignProjectGenBtn = document.getElementById("pdAiAssignProjectGenBtn");
	 const assignProjectLoading = document.getElementById("pdAiAssignProjectLoading");
	 const assignProjectList = document.getElementById("pdAiAssignProjectList");
	 const assignProjectApplyBtn = document.getElementById("pdAiAssignProjectApplyBtn");
	
	 let aiProjectAssigns = [];
	
	 function openProjectAssignModal(){
	   assignProjectList.innerHTML = "";
	   assignProjectNote.value = "";
	   aiProjectAssigns = [];
	   assignProjectModal.style.display="flex";
	 }
	 function closeProjectAssignModal(){
	   assignProjectModal.style.display="none";
	 }
	
	 assignProjectClose?.addEventListener("click", closeProjectAssignModal);
	 assignProjectModal?.addEventListener("click", e=>{
	   if(e.target===assignProjectModal) closeProjectAssignModal();
	 });
	
	 aiAssignBtn?.addEventListener("click", openProjectAssignModal);
	
	 // b·∫•m Generate m·ªõi g·ªçi AI
		assignProjectGenBtn?.addEventListener("click", () => {
		  assignProjectLoading.style.display = "inline";
		  assignProjectList.innerHTML = "";
		
		  const note = assignProjectNote.value || "";
		
		  fetch(`/api/ai/projects/${projectId}/suggest-assignments?note=${encodeURIComponent(note)}`, {
		    method: "POST"
		  })
		    .then(r => r.json())
		    .then(data => {
		      aiProjectAssigns = data || [];
		
		      if (aiProjectAssigns.length === 0) {
		        assignProjectList.innerHTML = `<p style="font-size:13px;">AI ch∆∞a g·ª£i √Ω ƒë∆∞·ª£c.</p>`;
		        return;
		      }
		
		      const frag = document.createDocumentFragment();
		
		      aiProjectAssigns.forEach(a => {
		        const div = document.createElement("div");
		        div.className = "pd-ai-assign-card";
		
		        const peopleHtml = (a.assigneeIds || [])
		          .map(uid => `
		            <span class="pd-ai-assign-pill">
		              <span class="dot"></span>
		              ${getMemberName(uid)}
		            </span>
		          `).join("");
		
		        const reason = a.reason || a.explanation || "";
		
		        div.innerHTML = `
		          <div class="pd-ai-assign-card__head">
		            <div class="pd-ai-assign-card__task">TASK-${a.taskId}</div>
		          </div>
		
		          <div class="pd-ai-assign-people">
		            ${peopleHtml || `<span style="font-size:12px;color:#aaa;">No assignees</span>`}
		          </div>
		
		          ${reason ? `<div class="pd-ai-assign-reason">üí° ${reason}</div>` : ""}
		        `;
		
		        frag.appendChild(div);
		      });
		
		      assignProjectList.appendChild(frag);
		    })
		    .catch(err => {
		      console.error(err);
		      assignProjectList.innerHTML = `<p style="color:#f66;font-size:13px;">AI l·ªói.</p>`;
		    })
		    .finally(() => {
		      assignProjectLoading.style.display = "none";
		    });
		});


	
	 // Apply gi·ªØ nguy√™n
	 assignProjectApplyBtn?.addEventListener("click", ()=>{
	   if(!aiProjectAssigns.length) return alert("Ch∆∞a c√≥ g·ª£i √Ω");
	
	   fetch(`/projects/${projectId}/tasks/apply-ai-assignments`, {
	     method:"POST",
	     headers:{"Content-Type":"application/json"},
	     body: JSON.stringify(aiProjectAssigns)
	   })
	   .then(r=>{
	     if(!r.ok) throw new Error("apply error");
	     location.reload();
	   })
	   .catch(err=>{
	     console.error(err);
	     alert("Apply th·∫•t b·∫°i");
	   });
	 });

    // Click "Use in create form"
    if (aiList) {
        aiList.addEventListener('click', function (e) {
            const btn = e.target.closest('.pd-ai-use-btn');
            if (!btn) return;

            const idx = parseInt(btn.getAttribute('data-index'), 10);
            const data = aiList.__aiData;
            if (!data || isNaN(idx) || !data[idx]) return;

            const task = data[idx];
            openCreateModalWithSuggestion(task);
        });
    }

    // N·∫øu c√≤n gi·ªØ ch·ª©c nƒÉng "Save selected as tasks" th√¨ ƒë·ªÉ; kh√¥ng th√¨ c√≥ th·ªÉ b·ªè ƒëo·∫°n n√†y:
    if (aiSaveBtn) {
        aiSaveBtn.addEventListener('click', function () {
            const data = aiList.__aiData;
            if (!data || !Array.isArray(data) || data.length === 0) {
                alert('Ch∆∞a c√≥ g·ª£i √Ω n√†o ƒë·ªÉ l∆∞u.');
                return;
            }

            const checkboxes = aiList.querySelectorAll('.pd-ai-task-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('H√£y ch·ªçn √≠t nh·∫•t 1 g·ª£i √Ω ƒë·ªÉ l∆∞u.');
                return;
            }

            const selected = [];
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.getAttribute('data-index'), 10);
                if (!isNaN(idx) && data[idx]) {
                    selected.push(data[idx]);
                }
            });

            fetch('/projects/' + projectId + '/tasks/from-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(selected)
            })
                .then(resp => {
                    if (!resp.ok) throw new Error('Save error ' + resp.status);
                    return resp.text();
                })
                .then(res => {
                    window.location.reload();
                })
                .catch(err => {
                    console.error(err);
                    alert('L∆∞u task th·∫•t b·∫°i, coi log console.');
                });
        });
    }


 // ===== helper: l·∫•y t√™n member theo userId =====
    const members = Array.from(document.querySelectorAll("#taskDetailAssigneesSelect option"))
      .map(o => ({ id: parseInt(o.value,10), name: o.textContent }));

    function getMemberName(uid){
      const m = members.find(x => x.id === uid);
      return m ? m.name : ("User " + uid);
    }

// ===== AI SUGGEST ASSIGNEE PER TASK =====
const assignModal = document.getElementById("pdAiAssignModal");
const assignClose  = document.getElementById("pdAiAssignClose");
const assignLoading = document.getElementById("pdAiAssignLoading");
const assignList = document.getElementById("pdAiAssignList");
const assignApplyBtn = document.getElementById("pdAiAssignApplyBtn");
const assignTaskTitle = document.getElementById("pdAiAssignTaskTitle");

let currentAiAssignTaskId = null;
let currentAiAssign = null;

function openAssignModal() {
  assignList.innerHTML = "";
  assignModal.style.display = "flex";
}
function closeAssignModal() {
  assignModal.style.display = "none";
  currentAiAssignTaskId = null;
  currentAiAssign = null;
}

assignClose?.addEventListener("click", closeAssignModal);
assignModal?.addEventListener("click", (e) => {
  if (e.target === assignModal) closeAssignModal();
});

boardEl.addEventListener("click", function(e){
  const btn = e.target.closest(".pd-ai-assign-btn");
  if(!btn) return;

  const taskId = btn.getAttribute("data-task-id");
  const card = btn.closest(".pd-card");
  const taskTitle = card?.getAttribute("data-task-summary") || ("TASK-" + taskId);

  currentAiAssignTaskId = taskId;
  assignTaskTitle.textContent = taskTitle;

  openAssignModal();
  assignLoading.style.display = "block";

  // g·ªçi project-level, r·ªìi filter theo taskId
  fetch(`/api/ai/projects/${projectId}/suggest-assignments`, { method:"POST" })
    .then(r => r.json())
    .then(all => {
      currentAiAssign = (all || []).find(x => x.taskId == taskId);

      if(!currentAiAssign){
        assignList.innerHTML = `<p style="font-size:13px;">AI ch∆∞a g·ª£i √Ω assignee cho task n√†y.</p>`;
        return;
      }

      const frag = document.createDocumentFragment();
      (currentAiAssign.assigneeIds || []).forEach(uid => {
        const opt = document.createElement("div");
        opt.className = "pd-ai-task-card";
        opt.innerHTML = `
          <div class="pd-ai-task-header">
            <input type="checkbox" class="pd-ai-assign-checkbox" data-uid="${uid}" checked>
            <span class="pd-ai-task-title">${getMemberName(uid)}</span>
          </div>
        `;
        frag.appendChild(opt);
      });

      assignList.appendChild(frag);
    })
    .catch(err => {
      console.error(err);
      assignList.innerHTML = `<p style="color:#f66; font-size:13px;">C√≥ l·ªói khi g·ªçi AI.</p>`;
    })
    .finally(() => assignLoading.style.display = "none");
});

assignApplyBtn?.addEventListener("click", function(){
  const checked = assignList.querySelectorAll(".pd-ai-assign-checkbox:checked");
  const assigneeIds = Array.from(checked).map(cb => parseInt(cb.dataset.uid,10));

  fetch(`/projects/${projectId}/tasks/${currentAiAssignTaskId}/assignees`, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(assigneeIds)
  })
  .then(r => {
    if(!r.ok) throw new Error("apply error");
    window.location.reload();
  })
  .catch(err => {
    console.error(err);
    alert("Apply th·∫•t b·∫°i");
  });
});
});


document.getElementById("taskDetailDeleteBtn")?.addEventListener("click", function (e) {
    e.preventDefault(); // tr√°nh submit form update
    if (!confirm("Delete this task permanently?")) return;

    const form = document.getElementById("pdTaskStatusForm");
    const url = form.action.replace("/update", "/delete");

    const csrf = document.getElementById("csrfToken")?.value;

    const deleteForm = document.createElement("form");
    deleteForm.method = "POST";
    deleteForm.action = url;

    // csrf
    const csrfField = document.createElement("input");
    csrfField.type = "hidden";
    csrfField.name = "_csrf";
    csrfField.value = csrf;
    deleteForm.appendChild(csrfField);

    document.body.appendChild(deleteForm);
    deleteForm.submit();
});


</script>

</div> <!-- /fragment -->

</body>
</html>
