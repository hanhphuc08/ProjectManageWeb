<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Project Detail | APT Project</title>

    <link href="/assets/css/styles.css" rel="stylesheet" />
    <link href="/assets/css/user-home.css" rel="stylesheet" />
    <link href="/assets/css/project-detail.css" rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="uh-dark">
<div class="uh-app">

    <!-- SIDEBAR -->
    <aside class="uh-sidebar">
        <div class="uh-sidebar-top">
            <div class="uh-logo">
                <span class="uh-logo-mark">APT</span>
                <span class="uh-logo-text">Project</span>
            </div>
        </div>

        <nav class="uh-nav">
            <a class="uh-nav-item" th:href="@{/projects}">
                <i class="fas fa-home"></i> For you
            </a>
            <a class="uh-nav-item" href="#"><i class="fas fa-clock"></i> Recent</a>
            <a class="uh-nav-item" href="#"><i class="fas fa-star"></i> Starred</a>

            <div class="uh-nav-section">Projects</div>

            <!-- Project hiện tại -->
            <a class="uh-nav-item is-active" href="#">
                <i class="fas fa-folder"></i>
                <span th:text="${project.projectName}">Project name</span>
            </a>

            <a class="uh-nav-item" th:href="@{/projects/create}">
                <i class="fas fa-plus"></i> Create project
            </a>
        </nav>

        <div class="uh-sidebar-bottom">
            <a class="uh-nav-item" href="#"><i class="fas fa-users"></i> Teams</a>
            <a class="uh-nav-item" href="#"><i class="fas fa-ellipsis-h"></i> More</a>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="uh-main">
        <!-- header chung -->
        <th:block th:replace="~{commons/header :: header}"></th:block>

        <!-- nút Quickstart ở góc -->
        <th:block th:replace="~{users/project/fragments/quickstart :: toggle}"></th:block>

        <section class="uh-content">

            <!-- Project header -->
            <div class="pd-project-header">
                <div class="pd-project-title">
                    <span class="pd-project-icon"><i class="fas fa-folder"></i></span>
                    <h1 th:text="${project.projectName}">Project name</h1>
                    <span class="pd-project-emoji"><i class="fas fa-thumbs-up"></i></span>
                    <span class="pd-project-grid"><i class="fas fa-th"></i></span>
                </div>
            </div>

            <!-- TABS -->
            <th:block th:replace="~{users/project/fragments/tabs :: tabs}"></th:block>

            <!-- SUMMARY TAB -->
            <th:block th:replace="~{users/project/fragments/summary :: summaryContent}"></th:block>

            <!-- TIMELINE TAB -->
            <th:block th:replace="~{users/project/fragments/timeline :: timelineContent}"></th:block>

            <!-- CALENDAR TAB -->
            <th:block th:replace="~{users/project/fragments/calendar :: calendarContent}"></th:block>

            <!-- LIST TAB -->
            <th:block th:replace="~{users/project/fragments/list :: listContent}"></th:block>

            <!-- BOARD TAB -->
            <th:block th:replace="~{users/project/fragments/board :: boardContent}"></th:block>

        </section>
    </main>
</div>

<!-- QUICKSTART PANEL & MODAL -->
<th:block th:replace="~{users/project/fragments/quickstart :: panel}"></th:block>
<!-- <th:block th:replace="~{users/project/fragments/modals :: modals}"></th:block> -->
<!-- Task create modal -->
<th:block th:replace="~{users/project/fragments/task-form :: taskCreateModal}"></th:block>

<!-- TEAM MODAL -->
<div id="pdModalOverlay" class="pd-task-modal-overlay" style="display:none;">
    <div class="pd-task-modal" style="max-width:720px;">

        <div class="pd-task-modal-header">
            <div>
                <span class="pd-task-modal-title">Team của dự án</span>
                <span class="pd-task-status-pill">
                    <span th:text="${#lists.size(board.members)}">0</span> members
                </span>
            </div>
            <button type="button" id="pdModalClose" class="pd-task-modal-close">✕</button>
        </div>

        <div class="pd-task-modal-body pd-team-list">

            <div class="pd-form-row" style="margin-bottom:14px;">
                <button type="button" id="pdOpenAddMember" class="pd-btn-primary" style="padding:8px 18px;">
                    + Add member
                </button>
            </div>

            <div class="pd-team-items">
					<div class="pd-team-member-card" th:each="m : ${board.members}">
						<div class="pd-team-member-main">
							<div class="pd-team-avatar">
								<span th:text="${#strings.substring(m.fullName,0,1)}">T</span>
							</div>

							<div class="pd-team-info">
								<div class="pd-team-name-row">
									<span class="pd-team-name" th:text="${m.fullName}">Tuong</span>
									<span class="pd-team-role-badge" th:text="${m.role}">PM</span>
								</div>

								<div class="pd-team-skills"
									th:if="${m.skills != null and !m.skills.isEmpty()}">
									<span class="pd-skill-pill" th:each="s : ${m.skills}"
										th:text="${s}">Java</span>
								</div>
							</div>
						</div>

						<form th:if="${board.currentUserIsPm}"
							th:action="@{|/projects/${board.projectId}/members/${m.projectMemberId}/remove|}"
							method="post" class="pd-team-remove-form"
							onsubmit="return confirm('Xóa thành viên này khỏi dự án?');">
							<button type="submit" class="pd-btn-remove">Remove</button>
						</form>

					</div>
				</div>

        </div>

    </div>
</div>


<!-- ADD MEMBER MODAL -->
<div id="pdAddMemberOverlay" class="pd-task-modal-overlay" style="display:none;">
    <div class="pd-task-modal" style="max-width:720px;">

        <div class="pd-task-modal-header">
            <div>
                <span class="pd-task-modal-title">Add member</span>
            </div>
            <button type="button" id="pdAddMemberClose" class="pd-task-modal-close">✕</button>
        </div>

        <form th:action="@{'/projects/' + ${board.projectId} + '/members/add'}"
              th:object="${memberForm}"
              method="post">

            <input type="hidden" th:field="*{userId}" id="pmUserId"/>

            <div class="pd-task-modal-body">

                <!-- Search user -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Tìm thành viên</label>
                    <input type="text"
                           id="pmUserSearch"
                           class="pd-input"
                           placeholder="Tìm theo tên hoặc email..."/>
                </div>

                <div class="pd-form-row">
                    <div class="pm-user-list">
                        <div class="pm-user-item"
                             th:each="u : ${availableUsers}"
                             th:data-id="${u.userId}"
                             th:data-text="${u.fullName + ' ' + u.email}">
                            <div class="pm-user-name" th:text="${u.fullName}">Tên</div>
                            <div class="pm-user-email" th:text="${u.email}">email@example.com</div>
                        </div>
                    </div>
                </div>

                <!-- Role -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Vai trò trong dự án</label>
                    <select class="pd-select" th:field="*{projectRoleId}">
                        <option th:each="r : ${projectRoles}"
                                th:value="${r.projectRoleId}"
                                th:text="${r.roleName}">
                        </option>
                    </select>
                </div>

                <!-- Allocation -->
                <div class="pd-form-row">
                    <label class="pd-form-label">% tham gia</label>
                    <select class="pd-select" th:field="*{allocationPct}">
                        <option value="">Mặc định 100%</option>
                        <option value="50">50%</option>
                        <option value="80">80%</option>
                        <option value="100">100%</option>
                    </select>
                </div>

                <!-- Availability -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Hình thức</label>
                    <select class="pd-select" th:field="*{availability}">
                        <option value="FULL_TIME">Full-time</option>
                        <option value="PART_TIME">Part-time</option>
                    </select>
                </div>

                <!-- Skills -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Kỹ năng trong dự án</label>
                    <input class="pd-input"
                           th:field="*{skills}"
                           placeholder="VD: Java, Spring, Testing"/>
                    <div class="pd-subtext">Nhập nhiều kỹ năng, cách nhau bằng dấu phẩy.</div>
                </div>

            </div>

            <div class="pd-task-modal-footer">
                <button type="submit" class="pd-btn-primary">Thêm thành viên</button>
            </div>

        </form>
    </div>
</div>



<script>
/* =============================
   1. Avatar Menu Toggle
   ============================= */
(function(){
  const avatar = document.getElementById('uhAvatar');
  const menu = document.getElementById('uhMenu');

  function toggle(){ menu?.classList.toggle('is-open'); }
  function close(e){
    if(menu && avatar && !menu.contains(e.target) && !avatar.contains(e.target)){
      menu.classList.remove('is-open');
    }
  }

  if(avatar){
    avatar.addEventListener('click', toggle);
    document.addEventListener('click', close);
  }
})();



/* =============================
   2. Team Management Modal
   ============================= */
(function(){
  const peopleBtn = document.getElementById('pdPeopleBtn');
  const overlay = document.getElementById('pdModalOverlay');
  const closeBtn = document.getElementById('pdModalClose');
  const cancelBtn = document.getElementById('pdModalCancel');
  const saveBtn = document.getElementById('pdModalSave');

  function open(){ overlay.style.display = 'flex'; }
  function close(){ overlay.style.display = 'none'; }

  peopleBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  cancelBtn?.addEventListener('click', close);
  saveBtn?.addEventListener('click', close);

  overlay?.addEventListener('click', e => {
    if(e.target === overlay) close();
  });
})();



/* =============================
   3. Quickstart Panel Toggle
   ============================= */
   (function(){
	   const quickstartPanel = document.querySelector('.pd-quickstart');
	   if (quickstartPanel) {
	       quickstartPanel.remove();   // <--- XÓA KHỎI DOM VĨNH VIỄN
	   }
	 })();




/* =============================
   4. Tab Switching (Summary / Board / Calendar...)
   ============================= */
   (function(){
	   const tabs = document.querySelectorAll('.pd-tab[data-tab]');
	   const contents = document.querySelectorAll('.pd-tab-content');

	   function showTab(name) {
	     // 1. Tắt hết
	     tabs.forEach(t => t.classList.remove('is-active'));
	     contents.forEach(c => c.style.display = 'none');

	     // 2. Bật tab được chọn
	     const activeTab = document.querySelector(`.pd-tab[data-tab="${name}"]`);
	     const target = document.getElementById(name + '-content');

	     if (activeTab) activeTab.classList.add('is-active');
	     if (target) target.style.display = 'block';
	     console.log('Switch to tab:', name, '=>', !!target);
	   }

	   // Gắn sự kiện click cho các tab
	   tabs.forEach(tab => {
	     tab.addEventListener('click', function (e) {
	       e.preventDefault();
	       const name = this.getAttribute('data-tab');
	       if (!name) return;
	       showTab(name);
	     });
	   });

	   // Khởi tạo: luôn mở BOARD khi load
	   showTab('board');
	 })();



/* =============================
   5. Calendar – Add Task
   ============================= */
(function(){
  document.querySelectorAll('.pd-calendar-date').forEach(cell => {
    cell.addEventListener('click', e => {
      if(e.target.classList.contains('pd-calendar-task')) return;

      const form = cell.querySelector('.pd-calendar-task-form');
      const input = form.querySelector('.pd-calendar-task-input');
      form.classList.add('active');
      input.focus();
    });
  });

  document.querySelectorAll('.pd-calendar-task-form').forEach(form => {
    const input = form.querySelector('.pd-calendar-task-input');
    const btnCreate = form.querySelector('.pd-calendar-task-create');
    const btnCancel = form.querySelector('.pd-calendar-task-cancel');

    function addTask(){
      const name = input.value.trim();
      if(!name) return;

      const list = form.parentElement.querySelector('.pd-calendar-tasks');
      const task = document.createElement('div');
      task.className = 'pd-calendar-task';
      task.textContent = name;

      task.addEventListener('click', e => {
        e.stopPropagation();
        if(confirm('Delete this task?')) task.remove();
      });

      list.appendChild(task);

      input.value = '';
      form.classList.remove('active');
    }

    btnCreate.addEventListener('click', e => { e.stopPropagation(); addTask(); });
    btnCancel.addEventListener('click', e => {
      e.stopPropagation();
      input.value = '';
      form.classList.remove('active');
    });

    input.addEventListener('keypress', e => { if(e.key === 'Enter') addTask(); });
    input.addEventListener('keydown', e => { if(e.key === 'Escape') btnCancel.click(); });
  });
})();



/* =============================
   6. Issue Detail Modal (View / Edit)
   ============================= */
(function(){
  const overlay = document.getElementById('pdIssueOverlay');
  if(!overlay) return;

  const closeBtn = document.getElementById('pdIssueClose');
  const cancelBtn = document.getElementById('pdIssueCancel');
  const saveBtn = document.getElementById('pdIssueSave');

  const keyEl = document.getElementById('pdIssueKey');
  const titleEl = document.getElementById('pdIssueTitle');
  const descEl = document.getElementById('pdIssueDescription');
  const statusEl = document.getElementById('pdIssueStatus');
  const assigneeEl = document.getElementById('pdIssueAssignee');
  const dueEl = document.getElementById('pdIssueDue');
  const labelsEl = document.getElementById('pdIssueLabels');

  const titleInput = document.getElementById('pdIssueTitleInput');
  const descInput = document.getElementById('pdIssueDescriptionInput');
  const statusSelect = document.getElementById('pdIssueStatusSelect');
  const assigneeInput = document.getElementById('pdIssueAssigneeInput');
  const dueInput = document.getElementById('pdIssueDueInput');
  const labelsInput = document.getElementById('pdIssueLabelsInput');

  function prettyDate(ymd){
    if(!ymd) return 'None';
    try { return new Date(ymd).toDateString(); }
    catch { return 'None'; }
  }

  function loadData(){
    titleInput.value = titleEl.textContent || '';
    descInput.value = descEl.textContent === 'Add a description…' ? '' : descEl.textContent;
    statusSelect.value = statusEl.textContent || 'TO DO';
    assigneeInput.value = assigneeEl.textContent === 'Unassigned' ? '' : assigneeEl.textContent;
    labelsInput.value = labelsEl.textContent === 'None' ? '' : labelsEl.textContent;

    // Cannot convert pretty date → input date safely (skip)
    dueInput.value = '';
  }

  function openIssue(data){
    keyEl.textContent = data.key || 'KEY-1';
    titleEl.textContent = data.title || 'Issue title';
    statusEl.textContent = data.status || 'TO DO';
    assigneeEl.textContent = data.assignee || 'Unassigned';
    dueEl.textContent = data.due || 'None';

    overlay.style.display = 'flex';
    loadData();
  }

  function closeIssue(){ overlay.style.display = 'none'; }

  closeBtn?.addEventListener('click', closeIssue);
  cancelBtn?.addEventListener('click', closeIssue);
  overlay.addEventListener('click', e => { if(e.target === overlay) closeIssue(); });

  saveBtn?.addEventListener('click', () => {
    titleEl.textContent = titleInput.value || 'Issue title';
    descEl.textContent = descInput.value || 'Add a description…';
    statusEl.textContent = statusSelect.value;

    assigneeEl.textContent = assigneeInput.value || 'Unassigned';
    dueEl.textContent = prettyDate(dueInput.value);
    labelsEl.textContent = labelsInput.value || 'None';

    closeIssue();
  });



  /* =============================
     6.1 Open Issue from Board Cards
     ============================= */
  document.querySelectorAll('.pd-card').forEach(card => {
    card.style.cursor = 'pointer';
    card.addEventListener('click', function(){
      const key = this.querySelector('.pd-card-id')?.textContent?.trim();
      const title = this.querySelector('h4')?.textContent?.trim();
      const status = this.closest('.pd-column')?.querySelector('h3')?.textContent?.trim();

      openIssue({ key, title, status });
    });
  });


  /* =============================
     6.2 Open Issue from List Rows
     ============================= */
  document.querySelectorAll('#list-content .pd-list-row').forEach(row => {
    row.style.cursor = 'pointer';

    row.addEventListener('click', function(e){
      if(e.target.tagName === 'INPUT' || e.target.closest('a')) return;

      const key = this.querySelector('.pd-list-key')?.textContent?.trim();
      const title = this.querySelector('.pd-list-summary')?.textContent?.trim();
      const status = this.querySelector('.pd-list-status')?.textContent?.trim();
      const assignee = this.querySelector('.pd-list-assignee')?.textContent?.trim();
      const due = this.querySelector('.pd-list-due-date')?.textContent?.trim();

      openIssue({ key, title, status, assignee, due });
    });
  });


  /* =============================
     6.3 Open Issue from Calendar (double click)
     ============================= */
  document.querySelectorAll('.pd-calendar-task').forEach(task => {
    task.addEventListener('dblclick', e => {
      e.stopPropagation();

      const title = task.textContent.trim();
      const key = 'CAL-' + title.replace(/\s+/g,'-').toUpperCase().slice(0,10);

      openIssue({
        key,
        title,
        status: 'TO DO'
      });
    });
  });

})();

/* =============================
7. Toggle form Create Task bằng card "+ Create"
============================= */
(function () {
	  const overlay = document.getElementById('pdTaskModalOverlay');
	  const form = document.getElementById('pdTaskCreateForm');
	  const statusInput = document.getElementById('pdTaskStatusInput');
	  const statusBadge = document.getElementById('pdTaskModalStatusBadge');
	  const btnClose = document.getElementById('pdTaskModalClose');
	  const btnCancel = document.getElementById('pdTaskModalCancel');

	  if (!overlay || !form) return;

	  function open(status) {
	    statusInput.value = status;
	    statusBadge.textContent = status.replace('_', ' ');
	    overlay.style.display = 'flex';
	  }

	  function close() {
	    form.reset();
	    // reset lại status về TODO (tuỳ thích)
	    statusInput.value = 'TODO';
	    statusBadge.textContent = 'TODO';
	    overlay.style.display = 'none';
	  }

	  // click nút + Create ở các cột
	  document.querySelectorAll('.pd-create-task-open').forEach(btn => {
	    btn.addEventListener('click', function () {
	      const status = this.dataset.status || 'TODO';
	      open(status);
	    });
	  });

	  btnClose?.addEventListener('click', close);
	  btnCancel?.addEventListener('click', close);
	  overlay.addEventListener('click', e => {
	    if (e.target === overlay) close();
	  });
	})();
	
/* ===== TEAM MODAL + ADD MEMBER MODAL ===== */
(function () {
    const peopleBtn = document.getElementById('pdPeopleBtn');
    const teamOverlay = document.getElementById('pdModalOverlay');
    const teamClose = document.getElementById('pdModalClose');
    const openAddBtn = document.getElementById('pdOpenAddMember');

    const addOverlay = document.getElementById('pdAddMemberOverlay');
    const addClose = document.getElementById('pdAddMemberClose');

    function openTeam() {
        teamOverlay.style.display = 'flex';
    }
    function closeTeam() {
        teamOverlay.style.display = 'none';
    }
    function openAdd() {
        teamOverlay.style.display = 'none';
        addOverlay.style.display = 'flex';
    }
    function closeAdd() {
        addOverlay.style.display = 'none';
    }

    peopleBtn?.addEventListener('click', openTeam);
    teamClose?.addEventListener('click', closeTeam);
    teamOverlay?.addEventListener('click', e => {
        if (e.target === teamOverlay) closeTeam();
    });

    openAddBtn?.addEventListener('click', openAdd);
    addClose?.addEventListener('click', closeAdd);
    addOverlay?.addEventListener('click', e => {
        if (e.target === addOverlay) closeAdd();
    });

    // ===== Search user & chọn 1 user =====
    const searchInput = document.getElementById('pmUserSearch');
    const hiddenUserId = document.getElementById('pmUserId');
    const userItems = document.querySelectorAll('.pm-user-item');

    function updateFilter() {
        const q = (searchInput.value || '').toLowerCase();
        userItems.forEach(item => {
            const text = item.dataset.text.toLowerCase();
            item.style.display = text.includes(q) ? '' : 'none';
        });
    }

    searchInput?.addEventListener('input', updateFilter);

    userItems.forEach(item => {
        item.addEventListener('click', () => {
            userItems.forEach(i => i.classList.remove('is-selected'));
            item.classList.add('is-selected');
            hiddenUserId.value = item.dataset.id;
            searchInput.value = item.querySelector('.pm-user-name').textContent;
        });
    });
})();


</script>


</body>
</html>
