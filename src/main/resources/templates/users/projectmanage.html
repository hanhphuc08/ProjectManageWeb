<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Project Detail | APT Project</title>

    <link href="/assets/css/styles.css" rel="stylesheet" />
    <link href="/assets/css/user-home.css" rel="stylesheet" />
    <link href="/assets/css/project-detail.css" rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/pd-calendar.css"/>

</head>
<body class="uh-dark">
<div class="uh-app">

    <!-- SIDEBAR -->
    <aside class="uh-sidebar">
        <div class="uh-sidebar-top">
            <div class="uh-logo">
                <span class="uh-logo-mark">APT</span>
                <span class="uh-logo-text">Project</span>
            </div>
        </div>

        <nav class="uh-nav">
            <a class="uh-nav-item" th:href="@{/projects}">
                <i class="fas fa-home"></i> For you
            </a>
            <a class="uh-nav-item" href="#"><i class="fas fa-clock"></i> Recent</a>
            <a class="uh-nav-item" href="#"><i class="fas fa-star"></i> Starred</a>

            <div class="uh-nav-section">Projects</div>

            <!-- Project hiện tại -->
            <a class="uh-nav-item is-active" href="#">
                <i class="fas fa-folder"></i>
                <span th:text="${project.projectName}">Project name</span>
            </a>

            <a class="uh-nav-item" th:href="@{/projects/create}">
                <i class="fas fa-plus"></i> Create project
            </a>
        </nav>

        <div class="uh-sidebar-bottom">
            <a class="uh-nav-item" href="#"><i class="fas fa-users"></i> Teams</a>
            <a class="uh-nav-item" href="#"><i class="fas fa-ellipsis-h"></i> More</a>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="uh-main">
        <!-- header chung -->
        <th:block th:replace="~{commons/header :: header}"></th:block>

        <!-- nút Quickstart ở góc -->
        <th:block th:replace="~{users/project/fragments/quickstart :: toggle}"></th:block>

        <section class="uh-content">

            <!-- Project header -->
            <div class="pd-project-header">
                <div class="pd-project-title">
                    <span class="pd-project-icon"><i class="fas fa-folder"></i></span>
                    <h1 th:text="${project.projectName}">Project name</h1>
                    <span class="pd-project-emoji"><i class="fas fa-thumbs-up"></i></span>
                    <span class="pd-project-grid"><i class="fas fa-th"></i></span>
                </div>
            </div>

            <!-- TABS -->
            <th:block th:replace="~{users/project/fragments/tabs :: tabs}"></th:block>

            <!-- SUMMARY TAB -->
            <th:block th:replace="~{users/project/fragments/summary :: summaryContent}"></th:block>

            <!-- TIMELINE TAB -->
            <div id="timeline-content"
			     class="pd-tab-content"
			     style="display:none;"
			     data-loaded="0">
			</div>

            <!-- CALENDAR TAB -->
            <th:block th:replace="~{users/project/fragments/calendar :: calendarContent}"></th:block>

            <!-- LIST TAB -->
            <th:block th:replace="~{users/project/fragments/list :: listContent}"></th:block>

            <!-- BOARD TAB -->
            <th:block th:replace="~{users/project/fragments/board :: boardContent}"></th:block>
            
            <!-- Goals -->
           	<th:block th:replace="~{users/project/fragments/goals :: goalsContent}"></th:block>
            

        </section>
    </main>
</div>

<!-- QUICKSTART PANEL & MODAL -->
<th:block th:replace="~{users/project/fragments/quickstart :: panel}"></th:block>
<!-- <th:block th:replace="~{users/project/fragments/modals :: modals}"></th:block> -->
<!-- Task create modal -->
<th:block th:replace="~{users/project/fragments/task-form :: taskCreateModal}"></th:block>

<!-- TEAM MODAL -->
<div id="pdModalOverlay" class="pd-task-modal-overlay" style="display:none;">
    <div class="pd-task-modal" style="max-width:720px;">

        <div class="pd-task-modal-header">
            <div>
                <span class="pd-task-modal-title">Team của dự án</span>
                <span class="pd-task-status-pill">
                    <span th:text="${#lists.size(board.members)}">0</span> members
                </span>
            </div>
            <button type="button" id="pdModalClose" class="pd-task-modal-close">✕</button>
        </div>

        <div class="pd-task-modal-body pd-team-list">

            <div class="pd-form-row" style="margin-bottom:14px;">
                <button type="button" id="pdOpenAddMember" class="pd-btn-primary" style="padding:8px 18px;">
                    + Add member
                </button>
            </div>

            <div class="pd-team-items">
					<div class="pd-team-member-card" th:each="m : ${board.members}">
						<div class="pd-team-member-main">
							<div class="pd-team-avatar">
								<span th:text="${#strings.substring(m.fullName,0,1)}">T</span>
							</div>

							<div class="pd-team-info">
								<div class="pd-team-name-row">
									<span class="pd-team-name" th:text="${m.fullName}">Tuong</span>
									<span class="pd-team-role-badge" th:text="${m.role}">PM</span>
								</div>

								<div class="pd-team-skills"
									th:if="${m.skills != null and !m.skills.isEmpty()}">
									<span class="pd-skill-pill" th:each="s : ${m.skills}"
										th:text="${s}">Java</span>
								</div>
							</div>
						</div>

						<form th:if="${board.currentUserIsPm}"
							th:action="@{|/projects/${board.projectId}/members/${m.projectMemberId}/remove|}"
							method="post" class="pd-team-remove-form"
							onsubmit="return confirm('Xóa thành viên này khỏi dự án?');">
							<button type="submit" class="pd-btn-remove">Remove</button>
						</form>

					</div>
				</div>

        </div>

    </div>
</div>


<!-- ADD MEMBER MODAL -->
<div id="pdAddMemberOverlay" class="pd-task-modal-overlay" style="display:none;">
    <div class="pd-task-modal" style="max-width:720px;">

        <div class="pd-task-modal-header">
            <div>
                <span class="pd-task-modal-title">Add member</span>
            </div>
            <button type="button" id="pdAddMemberClose" class="pd-task-modal-close">✕</button>
        </div>

        <form th:action="@{'/projects/' + ${board.projectId} + '/members/add'}"
              th:object="${memberForm}"
              method="post">

            <input type="hidden" th:field="*{userId}" id="pmUserId"/>

            <div class="pd-task-modal-body">

                <!-- Search user -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Tìm thành viên</label>
                    <input type="text"
                           id="pmUserSearch"
                           class="pd-input"
                           placeholder="Tìm theo tên hoặc email..."/>
                </div>

                <div class="pd-form-row">
                    <div class="pm-user-list">
                        <div class="pm-user-item"
                             th:each="u : ${availableUsers}"
                             th:data-id="${u.userId}"
                             th:data-text="${u.fullName + ' ' + u.email}">
                            <div class="pm-user-name" th:text="${u.fullName}">Tên</div>
                            <div class="pm-user-email" th:text="${u.email}">email@example.com</div>
                        </div>
                    </div>
                </div>

                <!-- Role -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Vai trò trong dự án</label>
                    <select class="pd-select" th:field="*{projectRoleId}">
                        <option th:each="r : ${projectRoles}"
                                th:value="${r.projectRoleId}"
                                th:text="${r.roleName}">
                        </option>
                    </select>
                </div>

                <!-- Allocation -->
                <div class="pd-form-row">
                    <label class="pd-form-label">% tham gia</label>
                    <select class="pd-select" th:field="*{allocationPct}">
                        <option value="">Mặc định 100%</option>
                        <option value="50">50%</option>
                        <option value="80">80%</option>
                        <option value="100">100%</option>
                    </select>
                </div>

                <!-- Availability -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Hình thức</label>
                    <select class="pd-select" th:field="*{availability}">
                        <option value="FULL_TIME">Full-time</option>
                        <option value="PART_TIME">Part-time</option>
                    </select>
                </div>

                <!-- Skills -->
                <div class="pd-form-row">
                    <label class="pd-form-label">Kỹ năng trong dự án</label>
                    <input class="pd-input"
                           th:field="*{skills}"
                           placeholder="VD: Java, Spring, Testing"/>
                    <div class="pd-subtext">Nhập nhiều kỹ năng, cách nhau bằng dấu phẩy.</div>
                </div>

            </div>

            <div class="pd-task-modal-footer">
                <button type="submit" class="pd-btn-primary">Thêm thành viên</button>
            </div>

        </form>
    </div>
</div>


<script src="/assets/js/calendar.js"></script>
<script th:inline="javascript">

const PROJECT_ID = /*[[${board.projectId}]]*/ 0;
/* =============================
   1. Avatar Menu Toggle
   ============================= */
(function(){
  const avatar = document.getElementById('uhAvatar');
  const menu = document.getElementById('uhMenu');

  function toggle(){ menu?.classList.toggle('is-open'); }
  function close(e){
    if(menu && avatar && !menu.contains(e.target) && !avatar.contains(e.target)){
      menu.classList.remove('is-open');
    }
  }

  if(avatar){
    avatar.addEventListener('click', toggle);
    document.addEventListener('click', close);
  }
})();



/* =============================
   2. Team Management Modal
   ============================= */
(function(){
  const peopleBtn = document.getElementById('pdPeopleBtn');
  const overlay = document.getElementById('pdModalOverlay');
  const closeBtn = document.getElementById('pdModalClose');
  const cancelBtn = document.getElementById('pdModalCancel');
  const saveBtn = document.getElementById('pdModalSave');

  function open(){ overlay.style.display = 'flex'; }
  function close(){ overlay.style.display = 'none'; }

  peopleBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  cancelBtn?.addEventListener('click', close);
  saveBtn?.addEventListener('click', close);

  overlay?.addEventListener('click', e => {
    if(e.target === overlay) close();
  });
})();



/* =============================
   3. Quickstart Panel Toggle
   ============================= */
   (function(){
	   const quickstartPanel = document.querySelector('.pd-quickstart');
	   if (quickstartPanel) {
	       quickstartPanel.remove();   // <--- XÓA KHỎI DOM VĨNH VIỄN
	   }
	 })();


// ===== helper parse local date (yyyy-MM-dd) tránh lệch timezone =====
   function parseLocalDate(ymd) {
  if (!ymd) return null;
  const part = ymd.trim().slice(0, 10);
  const [y, m, d] = part.split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(y, m - 1, d); // local midnight
}

window.initTimeline = function () {
  const gridEl   = document.getElementById("timelineGrid");
  const monthsEl = document.getElementById("timelineMonths");
  const taskEls  = document.querySelectorAll("#timelineTaskList .pd-timeline-task");
  if (!gridEl || !monthsEl || !taskEls.length) return;

  const tasks = Array.from(taskEls).map(el => {
    const start = parseLocalDate(el.dataset.start);
    const end   = parseLocalDate(el.dataset.end);
    return {
      id: el.dataset.taskId,
      title: el.querySelector(".pd-timeline-task-title")?.textContent.trim() || "",
      start,
      end,
      status: (el.dataset.status || "to_do")
    };
  }).filter(t => t.start && t.end);

  if (!tasks.length) return;

  const CELL_W = 40;
  const ROW_H  = 44;
  const PAD_DAYS = 7;

  function daysBetween(a, b) {
    const ms = 24*60*60*1000;
    return Math.round((b - a)/ms);
  }
  function addDays(d, n){
    const x = new Date(d);
    x.setDate(x.getDate() + n);
    return x;
  }

  // range chuẩn theo min start / max end
  let minStart = tasks[0].start;
  let maxEnd   = tasks[0].end;
  tasks.forEach(t=>{
    if(t.start < minStart) minStart = t.start;
    if(t.end > maxEnd) maxEnd = t.end;
  });

  const rangeStart = addDays(minStart, -PAD_DAYS);
  const rangeEnd   = addDays(maxEnd, PAD_DAYS);
  const totalDays  = daysBetween(rangeStart, rangeEnd) + 1;

  // months header theo đúng số ngày mỗi tháng trong range
  function renderMonths(){
    monthsEl.innerHTML = "";
    let cur = new Date(rangeStart.getFullYear(), rangeStart.getMonth(), 1);
    const end = addDays(rangeStart, totalDays);

    while(cur < end){
      const monthStart = new Date(cur.getFullYear(), cur.getMonth(), 1);
      const monthEnd   = new Date(cur.getFullYear(), cur.getMonth()+1, 0);

      const visibleStart = monthStart < rangeStart ? rangeStart : monthStart;
      const visibleEnd   = monthEnd > end ? end : monthEnd;

      const days = daysBetween(visibleStart, visibleEnd) + 1;

      const mEl = document.createElement("div");
      mEl.className="pd-timeline-month";
      mEl.style.minWidth = `${days * CELL_W}px`;
      mEl.textContent = visibleStart.toLocaleString("vi-VN", {month:"long", year:"numeric"});
      monthsEl.appendChild(mEl);

      cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1);
    }
  }

  function renderGrid(){
    gridEl.innerHTML="";
    const today = new Date(); today.setHours(0,0,0,0);

    for(let i=0;i<totalDays;i++){
      const d = addDays(rangeStart, i); d.setHours(0,0,0,0);
      const cell=document.createElement("div");
      cell.className="pd-timeline-cell";
      if(d.getTime()===today.getTime()) cell.classList.add("is-today");
      gridEl.appendChild(cell);
    }
  }

  function renderBars(){
    document.querySelectorAll(".pd-timeline-bar").forEach(e=>e.remove());

    tasks.forEach((t, idx)=>{
      const offset   = daysBetween(rangeStart, t.start);
      const duration = daysBetween(t.start, t.end) + 1;

      const bar=document.createElement("div");
      bar.className=`pd-timeline-bar status-${t.status.toLowerCase().replace(/\s+/g,"_")}`;
      bar.style.left=`${offset * CELL_W}px`;
      bar.style.width=`${duration * CELL_W}px`;
      bar.style.top=`${idx * ROW_H + 8}px`;

      // bar chỉ hiện title
      bar.textContent = t.title;
      gridEl.appendChild(bar);
    });

    gridEl.style.height = `${tasks.length * ROW_H + 30}px`;
  }

  renderMonths();
  renderGrid();
  renderBars();

  // auto scroll tới today
  const todayCell = gridEl.querySelector(".is-today");
  if(todayCell) todayCell.scrollIntoView({behavior:"smooth", inline:"center"});
};





/* =============================
   4. Tab Switching (Summary / Board / Calendar...)
   ============================= */
   (function(){
	   const tabs = document.querySelectorAll('.pd-tab[data-tab]');

	   async function showTab(name) {
	     // ✅ re-query contents mỗi lần vì DOM có thể đổi
	     const contents = document.querySelectorAll('.pd-tab-content');

	     // 1) tắt hết
	     tabs.forEach(t => t.classList.remove('is-active'));
	     contents.forEach(c => c.style.display = 'none');

	     // 2) bật tab được chọn
	     const activeTab = document.querySelector(`.pd-tab[data-tab="${name}"]`);
	     let target = document.getElementById(name + '-content');

	     if (activeTab) activeTab.classList.add('is-active');
	     if (target) target.style.display = 'block';
	     

	     // 3) Lazy load timeline
		if (name === "timeline" && target && target.dataset.loaded !== "1") {
  try {
    const projectId = /*[[${board.projectId}]]*/ 0;
    const html = await fetch(`/projects/${projectId}/timeline`)
      .then(r => r.text());

    const tmp = document.createElement("div");
    tmp.innerHTML = html;

    const fragmentRoot = tmp.querySelector("#timeline-content");

    if (fragmentRoot) {
      // remove style khỏi ruột trước khi nhét
      fragmentRoot.querySelectorAll("style").forEach(st => st.remove());
      target.innerHTML = fragmentRoot.innerHTML;
    } else {
      target.innerHTML = html;
    }

    // rồi mới lấy style append head
    const styleTag = tmp.querySelector("style");
    if (styleTag && !document.getElementById("timeline-style")) {
      const s = document.createElement("style");
      s.id = "timeline-style";
      s.textContent = styleTag.textContent;
      document.head.appendChild(s);
    }

    target.dataset.loaded = "1";

    document.querySelectorAll(".pd-tab-content")
      .forEach(c => c.style.display = "none");
    target.style.display = "block";

    if (window.initTimeline) window.initTimeline();

  } catch (e) {
    console.error("Load timeline failed:", e);
  }
}


	     console.log('Switch to tab:', name);
	   }

	   // click tabs
	   tabs.forEach(tab => {
	     tab.addEventListener('click', function (e) {
	       e.preventDefault();
	       const name = this.getAttribute('data-tab');
	       if (!name) return;
	       showTab(name);
	     });
	   });

	   const hash = (location.hash || "").replace("#", "");
	   const initialTab = hash.endsWith("-content")
	       ? hash.replace("-content", "")
	       : (hash || "board");

	   showTab(initialTab);
	 })();





/* =============================
   5. Calendar – Add Task
   ============================= */
(function(){
  document.querySelectorAll('.pd-calendar-date').forEach(cell => {
    cell.addEventListener('click', e => {
      if(e.target.classList.contains('pd-calendar-task')) return;

      const form = cell.querySelector('.pd-calendar-task-form');
      const input = form.querySelector('.pd-calendar-task-input');
      form.classList.add('active');
      input.focus();
    });
  });

  document.querySelectorAll('.pd-calendar-task-form').forEach(form => {
    const input = form.querySelector('.pd-calendar-task-input');
    const btnCreate = form.querySelector('.pd-calendar-task-create');
    const btnCancel = form.querySelector('.pd-calendar-task-cancel');

    function addTask(){
      const name = input.value.trim();
      if(!name) return;

      const list = form.parentElement.querySelector('.pd-calendar-tasks');
      const task = document.createElement('div');
      task.className = 'pd-calendar-task';
      task.textContent = name;

      task.addEventListener('click', e => {
        e.stopPropagation();
        if(confirm('Delete this task?')) task.remove();
      });

      list.appendChild(task);

      input.value = '';
      form.classList.remove('active');
    }

    btnCreate.addEventListener('click', e => { e.stopPropagation(); addTask(); });
    btnCancel.addEventListener('click', e => {
      e.stopPropagation();
      input.value = '';
      form.classList.remove('active');
    });

    input.addEventListener('keypress', e => { if(e.key === 'Enter') addTask(); });
    input.addEventListener('keydown', e => { if(e.key === 'Escape') btnCancel.click(); });
  });
})();



/* =============================
   6. Issue Detail Modal (View / Edit)
   ============================= */
(function(){
  const overlay = document.getElementById('pdIssueOverlay');
  if(!overlay) return;

  const closeBtn = document.getElementById('pdIssueClose');
  const cancelBtn = document.getElementById('pdIssueCancel');
  const saveBtn = document.getElementById('pdIssueSave');

  const keyEl = document.getElementById('pdIssueKey');
  const titleEl = document.getElementById('pdIssueTitle');
  const descEl = document.getElementById('pdIssueDescription');
  const statusEl = document.getElementById('pdIssueStatus');
  const assigneeEl = document.getElementById('pdIssueAssignee');
  const dueEl = document.getElementById('pdIssueDue');
  const labelsEl = document.getElementById('pdIssueLabels');

  const titleInput = document.getElementById('pdIssueTitleInput');
  const descInput = document.getElementById('pdIssueDescriptionInput');
  const statusSelect = document.getElementById('pdIssueStatusSelect');
  const assigneeInput = document.getElementById('pdIssueAssigneeInput');
  const dueInput = document.getElementById('pdIssueDueInput');
  const labelsInput = document.getElementById('pdIssueLabelsInput');

  function prettyDate(ymd){
    if(!ymd) return 'None';
    try { return new Date(ymd).toDateString(); }
    catch { return 'None'; }
  }

  function loadData(){
    titleInput.value = titleEl.textContent || '';
    descInput.value = descEl.textContent === 'Add a description…' ? '' : descEl.textContent;
    statusSelect.value = statusEl.textContent || 'TO DO';
    assigneeInput.value = assigneeEl.textContent === 'Unassigned' ? '' : assigneeEl.textContent;
    labelsInput.value = labelsEl.textContent === 'None' ? '' : labelsEl.textContent;

    // Cannot convert pretty date → input date safely (skip)
    dueInput.value = '';
  }

  function openIssue(data){
    keyEl.textContent = data.key || 'KEY-1';
    titleEl.textContent = data.title || 'Issue title';
    statusEl.textContent = data.status || 'TO DO';
    assigneeEl.textContent = data.assignee || 'Unassigned';
    dueEl.textContent = data.due || 'None';

    overlay.style.display = 'flex';
    loadData();
  }

  function closeIssue(){ overlay.style.display = 'none'; }

  closeBtn?.addEventListener('click', closeIssue);
  cancelBtn?.addEventListener('click', closeIssue);
  overlay.addEventListener('click', e => { if(e.target === overlay) closeIssue(); });

  saveBtn?.addEventListener('click', () => {
    titleEl.textContent = titleInput.value || 'Issue title';
    descEl.textContent = descInput.value || 'Add a description…';
    statusEl.textContent = statusSelect.value;

    assigneeEl.textContent = assigneeInput.value || 'Unassigned';
    dueEl.textContent = prettyDate(dueInput.value);
    labelsEl.textContent = labelsInput.value || 'None';

    closeIssue();
  });



  /* =============================
     6.1 Open Issue from Board Cards
     ============================= */
  document.querySelectorAll('.pd-card').forEach(card => {
    card.style.cursor = 'pointer';
    card.addEventListener('click', function(){
      const key = this.querySelector('.pd-card-id')?.textContent?.trim();
      const title = this.querySelector('h4')?.textContent?.trim();
      const status = this.closest('.pd-column')?.querySelector('h3')?.textContent?.trim();

      openIssue({ key, title, status });
    });
  });


  /* =============================
     6.2 Open Issue from List Rows
     ============================= */
  document.querySelectorAll('#list-content .pd-list-row').forEach(row => {
    row.style.cursor = 'pointer';

    row.addEventListener('click', function(e){
      if(e.target.tagName === 'INPUT' || e.target.closest('a')) return;

      const key = this.querySelector('.pd-list-key')?.textContent?.trim();
      const title = this.querySelector('.pd-list-summary')?.textContent?.trim();
      const status = this.querySelector('.pd-list-status')?.textContent?.trim();
      const assignee = this.querySelector('.pd-list-assignee')?.textContent?.trim();
      const due = this.querySelector('.pd-list-due-date')?.textContent?.trim();

      openIssue({ key, title, status, assignee, due });
    });
  });


  /* =============================
     6.3 Open Issue from Calendar (double click)
     ============================= */
  document.querySelectorAll('.pd-calendar-task').forEach(task => {
    task.addEventListener('dblclick', e => {
      e.stopPropagation();

      const title = task.textContent.trim();
      const key = 'CAL-' + title.replace(/\s+/g,'-').toUpperCase().slice(0,10);

      openIssue({
        key,
        title,
        status: 'TO DO'
      });
    });
  });

})();

/* =============================
7. Toggle form Create Task bằng card "+ Create"
============================= */
(function () {
	  const overlay = document.getElementById('pdTaskModalOverlay');
	  const form = document.getElementById('pdTaskCreateForm');
	  const statusInput = document.getElementById('pdTaskStatusInput');
	  const statusBadge = document.getElementById('pdTaskModalStatusBadge');
	  const btnClose = document.getElementById('pdTaskModalClose');
	  const btnCancel = document.getElementById('pdTaskModalCancel');

	  if (!overlay || !form) return;
	  overlay.style.display = 'none';

	  function open(status) {
	    statusInput.value = status;
	    statusBadge.textContent = status.replace('_', ' ');
	    overlay.style.display = 'flex';
	  }

	  function close() {
	    form.reset();
	    // reset lại status về TODO (tuỳ thích)
	    statusInput.value = 'TODO';
	    statusBadge.textContent = 'TODO';
	    overlay.style.display = 'none';
	  }

	  // click nút + Create ở các cột
	  document.querySelectorAll('.pd-create-task-open').forEach(btn => {
	    btn.addEventListener('click', function () {
	      const status = this.dataset.status || 'TODO';
	      open(status);
	    });
	  });

	  btnClose?.addEventListener('click', close);
	  btnCancel?.addEventListener('click', close);
	  overlay.addEventListener('click', e => {
	    if (e.target === overlay) close();
	  });
	})();
	
/* ===== TEAM MODAL + ADD MEMBER MODAL ===== */
(function () {
    const peopleBtn = document.getElementById('pdPeopleBtn');
    const teamOverlay = document.getElementById('pdModalOverlay');
    const teamClose = document.getElementById('pdModalClose');
    const openAddBtn = document.getElementById('pdOpenAddMember');

    const addOverlay = document.getElementById('pdAddMemberOverlay');
    const addClose = document.getElementById('pdAddMemberClose');

    function openTeam() {
        teamOverlay.style.display = 'flex';
    }
    function closeTeam() {
        teamOverlay.style.display = 'none';
    }
    function openAdd() {
        teamOverlay.style.display = 'none';
        addOverlay.style.display = 'flex';
    }
    function closeAdd() {
        addOverlay.style.display = 'none';
    }

    peopleBtn?.addEventListener('click', openTeam);
    teamClose?.addEventListener('click', closeTeam);
    teamOverlay?.addEventListener('click', e => {
        if (e.target === teamOverlay) closeTeam();
    });

    openAddBtn?.addEventListener('click', openAdd);
    addClose?.addEventListener('click', closeAdd);
    addOverlay?.addEventListener('click', e => {
        if (e.target === addOverlay) closeAdd();
    });

    // ===== Search user & chọn 1 user =====
    const searchInput = document.getElementById('pmUserSearch');
    const hiddenUserId = document.getElementById('pmUserId');
    const userItems = document.querySelectorAll('.pm-user-item');

    function updateFilter() {
        const q = (searchInput.value || '').toLowerCase();
        userItems.forEach(item => {
            const text = item.dataset.text.toLowerCase();
            item.style.display = text.includes(q) ? '' : 'none';
        });
    }

    searchInput?.addEventListener('input', updateFilter);

    userItems.forEach(item => {
        item.addEventListener('click', () => {
            userItems.forEach(i => i.classList.remove('is-selected'));
            item.classList.add('is-selected');
            hiddenUserId.value = item.dataset.id;
            searchInput.value = item.querySelector('.pm-user-name').textContent;
        });
    });
})();



/* =============================
GOALS – Create, Link, View, Unlink
============================= */
(function () {
// Lấy projectId từ global hoặc từ Thymeleaf
const projectId = window.PROJECT_ID || /*[[${board.projectId}]]*/ 0;

/* ---------- A. Create Goal Modal ---------- */
const goalCreateBtn   = document.getElementById('pdGoalCreateBtn');
const goalModal       = document.getElementById('pdGoalModalOverlay');
const goalModalClose  = document.getElementById('pdGoalModalClose');
const goalModalCancel = document.getElementById('pdGoalModalCancel');

function openGoalCreate() {
 if (!goalModal) return;
 goalModal.style.display = 'flex';
}
function closeGoalCreate() {
 if (!goalModal) return;
 goalModal.style.display = 'none';
}

goalCreateBtn?.addEventListener('click', openGoalCreate);
goalModalClose?.addEventListener('click', closeGoalCreate);
goalModalCancel?.addEventListener('click', closeGoalCreate);
goalModal?.addEventListener('click', e => {
 if (e.target === goalModal) closeGoalCreate();
});

/* ---------- B. Link Tasks to Goal (modal) ---------- */

const overlay     = document.getElementById('pdGoalTaskOverlay');
const titleSpan   = document.getElementById('pdGoalTaskTitle');
const listEl      = document.getElementById('pdGoalTaskList');
const emptyEl     = document.getElementById('pdGoalTaskEmpty');
const searchInput = document.getElementById('pdGoalTaskSearch');
const closeBtn    = document.getElementById('pdGoalTaskClose');
const cancelBtn   = document.getElementById('pdGoalTaskCancel');
const saveBtn     = document.getElementById('pdGoalTaskSave');

let currentGoalId = null;
let rawTasks      = [];

// Render danh sách task trong modal Link
function renderLinkTaskList(filterText) {
 const q = (filterText || '').toLowerCase();
 listEl.innerHTML = '';

 const filtered = rawTasks.filter(t => {
   const s = ((t.title || '') + ' ' + (t.status || '') + ' ' + (t.taskId || '')).toLowerCase();
   return s.includes(q);
 });

 if (!filtered.length) {
   emptyEl.style.display = 'block';
   return;
 }
 emptyEl.style.display = 'none';

 const frag = document.createDocumentFragment();

 filtered.forEach(t => {
   const row = document.createElement('label');
   row.className = 'pd-goal-task-row';

   const due = t.dueDate ? ` · Due: ${t.dueDate}` : '';
   const status = t.status || 'TO DO';
   const statusSlug = status.toLowerCase().replace(/\s+/g, '-');

   row.innerHTML = `
     <input type="checkbox" class="pd-goal-task-checkbox" value="${t.taskId}">
     <div class="pd-goal-task-info">
       <div class="pd-goal-task-title">
         [TASK-${t.taskId}] ${t.title || 'Untitled'}
       </div>
       <div class="pd-goal-task-meta">
         <span class="st-pill st-${statusSlug}">
           ${status}
         </span>
         ${due}
       </div>
     </div>
   `;

   frag.appendChild(row);
 });

 listEl.appendChild(frag);
}

function openLinkModal(goalId, goalTitle) {
 if (!overlay) return;
 currentGoalId = goalId;
 titleSpan.textContent = goalTitle || 'Goal';

 searchInput.value = '';
 listEl.innerHTML = '';
 emptyEl.style.display = 'none';
 overlay.style.display = 'flex';

 // Gọi API lấy task chưa gán cho goal
 fetch(`/api/projects/${projectId}/goals/${goalId}/available-tasks`)
   .then(r => {
     if (!r.ok) throw new Error('Failed to load tasks');
     return r.json();
   })
   .then(data => {
     rawTasks = Array.isArray(data) ? data : [];
     if (!rawTasks.length) {
       emptyEl.textContent = 'All tasks are already linked to this goal, or no tasks in project.';
       emptyEl.style.display = 'block';
       listEl.innerHTML = '';
     } else {
       renderLinkTaskList('');
     }
   })
   .catch(err => {
     console.error(err);
     emptyEl.textContent = 'Error while loading tasks. Please try again later.';
     emptyEl.style.display = 'block';
   });
}

function closeLinkModal() {
 if (!overlay) return;
 overlay.style.display = 'none';
 currentGoalId = null;
 rawTasks = [];
 listEl.innerHTML = '';
}

// Open từ nút "+ Link tasks"
document.querySelectorAll('.pd-goal-link-btn').forEach(btn => {
 btn.addEventListener('click', () => {
   const goalId = btn.dataset.goalId;
   const goalTitle = btn.dataset.goalTitle || 'Goal';
   if (!goalId) return;
   openLinkModal(goalId, goalTitle);
 });
});

closeBtn?.addEventListener('click', closeLinkModal);
cancelBtn?.addEventListener('click', closeLinkModal);
overlay?.addEventListener('click', e => {
 if (e.target === overlay) closeLinkModal();
});

searchInput?.addEventListener('input', () => {
 renderLinkTaskList(searchInput.value);
});

// Save: POST danh sách taskIds
saveBtn?.addEventListener('click', () => {
 if (!currentGoalId) return;

 const checked = listEl.querySelectorAll('.pd-goal-task-checkbox:checked');
 if (!checked.length) {
   alert('Please select at least one task.');
   return;
 }

 const formData = new URLSearchParams();
 checked.forEach(ch => formData.append('taskIds', ch.value));

 fetch(`/projects/${projectId}/goals/${currentGoalId}/tasks`, {
   method: 'POST',
   body: formData
 })
   .then(r => {
     if (!r.ok) throw new Error('Save failed');
     // Reload để cập nhật progress & ẩn task đã gán
  // Đảm bảo đang ở tab Goals
     window.location.hash = '#goals';
     // Reload để server render lại goals + progress
     window.location.reload();
   })
   .catch(err => {
     console.error(err);
     alert('Có lỗi khi gán task vào goal.');
   });
});

/* ---------- C. View linked tasks + Remove khỏi goal ---------- */

function formatDate(ymd) {
 if (!ymd) return '';
 try {
   return new Date(ymd).toLocaleDateString('vi-VN');
 } catch {
   return ymd;
 }
}

document.querySelectorAll('.pd-goal-view-btn').forEach(btn => {
 btn.addEventListener('click', () => {
   const goalId = btn.dataset.goalId;
   if (!goalId) return;

   const container = document.getElementById('goal-tasks-' + goalId);
   if (!container) return;

   // Toggle đóng / mở
   if (container.style.display === 'block') {
     container.style.display = 'none';
     return;
   }

   // Nếu đã load trước rồi thì chỉ mở lại
   if (container.dataset.loaded === '1') {
     container.style.display = 'block';
     return;
   }

   container.innerHTML = '<div class="pd-subtext">Loading tasks...</div>';
   container.style.display = 'block';

   fetch(`/api/projects/${projectId}/goals/${goalId}/tasks`)
     .then(r => {
       if (!r.ok) throw new Error('Failed to load goal tasks');
       return r.json();
     })
     .then(data => {
       if (!Array.isArray(data) || data.length === 0) {
         container.innerHTML = '<div class="pd-subtext">No tasks linked yet.</div>';
         container.dataset.loaded = '1';
         return;
       }

       const wrapper = document.createElement('div');
       wrapper.className = 'pd-goal-task-inline-wrapper';

       data.forEach(t => {
         const row = document.createElement('div');
         row.className = 'pd-goal-task-inline-row';

         const title = t.title || 'Untitled';
         const status = t.status || 'TO DO';
         const statusSlug = status.toLowerCase().replace(/\s+/g, '_');
         const assignee = t.assigneeName || 'Unassigned';
         const due = t.dueDate ? formatDate(t.dueDate) : '';

         row.innerHTML = `
           <div class="pd-goal-task-inline-main">
             <div class="pd-goal-task-inline-title">
               [TASK-${t.taskId}] ${title}
             </div>
             <div class="pd-goal-task-inline-meta">
               <span class="st-pill st-${statusSlug}">${status}</span>
               <span class="pd-goal-task-inline-assignee">
                 <i class="fas fa-user"></i> ${assignee}
               </span>
               ${
                 due
                   ? `<span class="pd-goal-task-inline-due">
                        <i class="fas fa-calendar-alt"></i> ${due}
                      </span>`
                   : ''
               }
             </div>
           </div>
           <div class="pd-goal-task-inline-actions">
             <button type="button"
                     class="pd-goal-task-unlink"
                     data-goal-id="${goalId}"
                     data-task-id="${t.taskId}">
               Remove
             </button>
           </div>
         `;

         wrapper.appendChild(row);
       });

       container.innerHTML = '';
       container.appendChild(wrapper);
       container.dataset.loaded = '1';

       // Gắn event Remove
       container.querySelectorAll('.pd-goal-task-unlink').forEach(unlinkBtn => {
         unlinkBtn.addEventListener('click', async function () {
           const gid = this.dataset.goalId;
           const tid = this.dataset.taskId;
           if (!gid || !tid) return;

           if (!confirm('Remove this task from goal?')) return;

           try {
             const resp = await fetch(`/projects/${projectId}/goals/${gid}/tasks/${tid}/unlink`, {
               method: 'POST'
             });
             if (!resp.ok) {
               throw new Error('HTTP ' + resp.status);
             }

             const row = this.closest('.pd-goal-task-inline-row');
             if (row) row.remove();

             // Nếu không còn task → hiển thị empty
             if (!container.querySelector('.pd-goal-task-inline-row')) {
               container.innerHTML = '<div class="pd-subtext">No tasks linked yet.</div>';
             }
             
             if (!resp.ok) throw new Error('Unlink failed');

             window.location.hash = '#goals';
             window.location.reload();

             // Optional: reload để progress cập nhật:
             // window.location.href = `/projects/${projectId}#goals`;
           } catch (e) {
             console.error('Unlink task error:', e);
             alert('Có lỗi khi gỡ task khỏi goal.');
           }
         });
       });
     })
     .catch(err => {
       console.error(err);
       container.innerHTML =
         '<div class="pd-subtext" style="color:#f97373;">Error loading tasks.</div>';
     });
 });
});

})();



</script>


</body>
</html>
