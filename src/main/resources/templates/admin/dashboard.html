<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Owner Dashboard | APT Project</title>

    <!-- CSS chung của project -->
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="theme-dark-dashboard">

<div class="layout">

    <aside class="sidebar-placeholder">
        <h2>APT Project</h2>
        <ul>
            <li><span>Board</span></li>
            <li><span>Calendar</span></li>
            <li><span>Projects</span></li>
            <li class="active"><span>Owner Dashboard</span></li>
            <li><span>Settings</span></li>
            <li>
			    <a href="/logout" class="logout-btn">
			        <span>Đăng xuất</span>
			    </a>
			</li>
			            
        </ul>
    </aside>

    <main class="main-content">
        <!-- HEADER -->
        <header class="page-header">
            <div>
                <div class="page-title">Tổng quan hệ thống</div>
                <div class="page-subtitle">
                    Xem nhanh mức độ sử dụng hệ thống, số lượng dự án, người dùng và task.
                </div>
            </div>
            <div class="header-actions">
                <select class="select">
                    <option>7 ngày gần đây</option>
                    <option>Hôm nay</option>
                    <option>Tháng này</option>
                    <option>3 tháng gần đây</option>
                </select>
                <button class="btn-icon">↻</button>
            </div>
        </header>

        <!-- KPI CARDS -->
        <section class="kpi-grid">
            <!-- Tổng user + user mới -->
            <div class="kpi-card kpi-accent">
                <div class="kpi-title">Tổng số người dùng</div>
                <div class="kpi-value"
                     th:text="${dashboard.totalUsers}">0</div>
                <div class="kpi-sub"
                     th:text="|+${dashboard.newUsersLast7Days} user mới trong 7 ngày|">
                    +0 user mới trong 7 ngày
                </div>
            </div>

            <!-- Tổng project -->
            <div class="kpi-card">
                <div class="kpi-title">Tổng số project</div>
                <div class="kpi-value"
                     th:text="${dashboard.totalProjects}">0</div>
                <div class="kpi-sub">Tất cả dự án trong hệ thống</div>
            </div>

            <!-- Tổng task -->
            <div class="kpi-card">
                <div class="kpi-title">Tổng số task</div>
                <div class="kpi-value"
                     th:text="${dashboard.totalTasks}">0</div>
                <div class="kpi-sub">Tổng task trên mọi project</div>
            </div>
        </section>

        <!-- CHARTS: PROJECT & TASK STATUS -->
        <section class="section-row two-col">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Project theo trạng thái</div>
                    <div class="card-extra">Planned / In Progress / Completed / On Hold...</div>
                </div>
                <div>
                    <canvas id="projectStatusChart" height="210"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Task theo trạng thái</div>
                    <div class="card-extra">To Do / In Progress / Done...</div>
                </div>
                <div>
                    <canvas id="taskStatusChart" height="210"></canvas>
                </div>
            </div>
        </section>

        <!-- TABLES: RECENT PROJECTS & USER BY ROLE -->
        <section class="section-row two-col">
            <!-- Recent Projects -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Project mới cập nhật</div>
                    <a th:href="@{/projects}" class="card-extra">Xem tất cả project</a>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th>Project</th>
                            <th>Loại</th>
                            <th>Người tạo</th>
                            <th>Bắt đầu</th>
                            <th>Kết thúc</th>
                            <th>Trạng thái</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="p : ${dashboard.recentProjects}">
                            <td th:text="${p.name}">APT Project</td>
                            <td th:text="${p.typeName}">Internal</td>
                            <td th:text="${p.createdByName}">Hoàng Mạnh Tường</td>
                            <td th:text="${p.startDate}">2025-11-01</td>
                            <td th:text="${p.endDate}">2025-12-30</td>
                            <td th:text="${p.status}">Planned</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(dashboard.recentProjects)}">
                            <td colspan="6" style="text-align:center; font-size:0.85rem; color:#9ca3af;">
                                Chưa có project nào gần đây.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users by Role -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Người dùng theo role</div>
                    <div class="card-extra">Phân loại ADMIN / PM / MEMBER</div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th>Role</th>
                            <th>Số lượng</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="r : ${dashboard.usersByRole}">
                            <td th:text="${r.roleName}">ADMIN</td>
                            <td th:text="${r.count}">10</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(dashboard.usersByRole)}">
                            <td colspan="2" style="text-align:center; font-size:0.85rem; color:#9ca3af;">
                                Chưa có dữ liệu người dùng theo role.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- JS BIND CHART DỮ LIỆU TỪ MODEL -->
<script th:inline="javascript">
/*<![CDATA[*/
    // projectByStatus: [{label:'Planned', count: 10}, ...]
    const projectStatusData = /*[[${dashboard.projectByStatus}]]*/ [];
    const projectStatusLabels = projectStatusData.map(s => s.label);
    const projectStatusCounts = projectStatusData.map(s => s.count);

    // taskByStatus: [{label:'To Do', count: 20}, ...]
    const taskStatusData = /*[[${dashboard.taskByStatus}]]*/ [];
    const taskStatusLabels = taskStatusData.map(t => t.label);
    const taskStatusCounts = taskStatusData.map(t => t.count);

    const projectStatusCtx = document.getElementById('projectStatusChart').getContext('2d');
    const taskStatusCtx    = document.getElementById('taskStatusChart').getContext('2d');

    new Chart(projectStatusCtx, {
        type: 'doughnut',
        data: {
            labels: projectStatusLabels,
            datasets: [{ data: projectStatusCounts }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    new Chart(taskStatusCtx, {
        type: 'bar',
        data: {
            labels: taskStatusLabels,
            datasets: [{ data: taskStatusCounts }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { font: { size: 11 } } },
                y: { beginAtZero: true }
            }
        }
    });
/*]]>*/
</script>

</body>
</html>
